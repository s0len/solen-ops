# Node: control-0
# IP: 192.168.10.40
# Hardware: Intel 12th gen, Intel GPU, SSD storage
---
machine:
  type: controlplane
  files:
    - op: create
      path: /etc/cri/conf.d/20-customization.part
      permissions: 0o644
      content: |
        [plugins."io.containerd.cri.v1.images"]
          discard_unpacked_layers = false
        [plugins."io.containerd.cri.v1.runtime"]
          cdi_spec_dirs = ["/var/cdi/static", "/var/cdi/dynamic"]
          device_ownership_from_security_context = true
  network:
    hostname: control-0
    interfaces:
      # Bond - LACP (802.3ad) - requires UniFi LAG on switch!
      - interface: bond0
        mtu: 1500
        dhcp: true
        bond:
          mode: 802.3ad
          lacpRate: fast
          xmitHashPolicy: layer3+4
          miimon: 100
          updelay: 200
          downdelay: 200
          deviceSelectors:
            - hardwareAddr: cc:96:e5:0e:8d:31 # Intel onboard
            - hardwareAddr: "00:10:18:00:04:76" # Broadcom PCIe
        vip:
          ip: 192.168.10.80
  install:
    diskSelector:
      model: "*SSD 870*"
    image: "factory.talos.dev/metal-installer/${TALOS_SCHEMATIC}:${TALOS_VERSION}"
    wipe: false
  sysfs:
    devices.system.cpu.intel_pstate.hwp_dynamic_boost: 1
  sysctls:
    vm.nr_hugepages: "1024"
  udev:
    rules:
      - SUBSYSTEM=="drm", KERNEL=="renderD*", GROUP="44", MODE="0660"
  nodeLabels:
    intel.feature.node.kubernetes.io/gpu: "true"
    topology.kubernetes.io/zone: zone-a
    node.kubernetes.io/storage: ceph
